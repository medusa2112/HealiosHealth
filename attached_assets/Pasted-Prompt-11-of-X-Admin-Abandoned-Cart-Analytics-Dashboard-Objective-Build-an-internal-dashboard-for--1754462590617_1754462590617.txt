Prompt 11 of X: Admin Abandoned Cart Analytics Dashboard
Objective: Build an internal dashboard for admins to view and track abandoned carts, identify users who didnâ€™t complete checkout, and segment them by cart value, last activity, and conversion status.

âœ… PHASE 1: SYSTEM SCAN (DATA INTEGRITY CHECK)
Before building the dashboard:

âœ… Confirm that:

carts table includes converted_to_order (Prompt 7)

last_updated is populated correctly

Each cart includes session_token, user_id, and items[] (with price, qty, product_id)

âŒ If items are stored with insufficient detail (e.g. just IDs), this dashboard cannot calculate cart value. Add:

ts
Copy
Edit
product_id, price, quantity
âœ… Confirm admin routes are locked with protectRoute(["admin"]) â€” no public exposure

ğŸ“Š PHASE 2: BACKEND ROUTE FOR ABANDONED CARTS
Create /routes/admin/carts.ts:

ts
Copy
Edit
import express from "express";
import { db } from "../../db";
import { carts } from "../../db/schema";
import { and, eq, lt } from "drizzle-orm";
import { protectRoute } from "../../lib/auth";

const router = express.Router();
router.use(protectRoute(["admin"]));

router.get("/", async (req, res) => {
  const oneHourAgo = new Date(Date.now() - 1000 * 60 * 60); // 1 hour

  const result = await db.select().from(carts).where(
    and(
      eq(carts.converted_to_order, false),
      lt(carts.last_updated, oneHourAgo)
    )
  );

  res.json(result);
});

export default router;
Mount in server.ts:

ts
Copy
Edit
import adminCarts from "./routes/admin/carts";
app.use("/admin/carts", adminCarts);
ğŸ“ˆ PHASE 3: ADMIN UI â€” /pages/admin/carts.tsx
Basic UI with time, value, and segmentation:

tsx
Copy
Edit
import { useEffect, useState } from "react";

export default function AdminCarts() {
  const [carts, setCarts] = useState([]);

  useEffect(() => {
    fetch("/admin/carts").then(res => res.json()).then(setCarts);
  }, []);

  const getTotalValue = (items: any[]) => {
    return items.reduce((sum, item) => sum + item.price * item.quantity, 0).toFixed(2);
  };

  return (
    <div className="p-6 space-y-4">
      <h1 className="text-xl font-bold">Abandoned Carts (Past Hour)</h1>
      <p className="text-sm text-gray-500">Showing carts not converted after 1 hour.</p>

      {carts.length === 0 && <p>No abandoned carts yet ğŸ‰</p>}

      {carts.map((cart: any) => (
        <div key={cart.id} className="border p-4 rounded">
          <div>ğŸ§¾ Cart ID: {cart.id}</div>
          <div>ğŸ“§ User ID: {cart.user_id ?? "Guest"}</div>
          <div>ğŸ›’ Total: ${getTotalValue(cart.items)}</div>
          <div>â° Last Updated: {new Date(cart.last_updated).toLocaleString()}</div>
          <div>ğŸ§ƒ Items: {cart.items.map(i => `${i.quantity}x ${i.name}`).join(", ")}</div>
        </div>
      ))}
    </div>
  );
}
Optional: Add filters for â€œGuest onlyâ€, â€œ> $100â€, or â€œLast 24hâ€

ğŸ” PHASE 4: OPTIONAL RE-TARGETING EXPORT
Add a Download CSV button to export:

tsx
Copy
Edit
const downloadCSV = () => {
  const headers = "Cart ID,User ID,Total Value,Last Updated\n";
  const rows = carts.map(c => `${c.id},${c.user_id ?? "Guest"},${getTotalValue(c.items)},${c.last_updated}`).join("\n");
  const blob = new Blob([headers + rows], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = "abandoned-carts.csv";
  link.click();
};
ğŸ§ª PHASE 5: STABILITY + ACCURACY TESTS
Test Case	Expected
Cart idle for > 1 hour, not converted	âœ… Shows in dashboard
Cart converted â†’ converted_to_order = true	âŒ Does NOT show
Admin access required	âœ… Yes
Guest carts tracked	âœ… Yes
CSV contains accurate value + timestamps	âœ… Confirmed

ğŸ“¦ OUTPUT FROM THIS PROMPT
/admin/carts route for retrieving abandoned carts

Admin UI with cart ID, user, value, time, and item list

Optional CSV export for marketing re-targeting

All logic scoped to converted_to_order === false && last_updated < now - 1h

