Prompt 17 of X: Final QA + Security Hardening + Failover Simulation
Objective: Conduct a full-system QA audit, verify all security layers, stress-test role protection and Stripe logic, and ensure the system fails gracefully under high-risk scenarios â€” before going live.

âœ… PHASE 1: FUNCTIONAL QA â€” FEATURE COMPLETENESS CHECKLIST
Check these across admin, customer, guest, and backend flows:

Area	Key Features	Status
âœ… Auth	Replit Auth, role-based (admin, customer, guest)	REQUIRED
âœ… Products	CRUD, variants, tags, pricing	REQUIRED
âœ… Orders	Webhook, refund, dispute sync	REQUIRED
âœ… Cart	Session + user carts, conversion tracking	REQUIRED
âœ… Stripe	Valid checkout, metadata, refunds, discounts	REQUIRED
âœ… Bundles	Multi-variant add, exclusion logic (e.g. children)	REQUIRED
âœ… Reorders	Logged funnel, Stripe retry flow	REQUIRED
âœ… Discounts	Admin-created, validated server-side	REQUIRED
âœ… Admin Logs	Refunds, product edits, uploads	REQUIRED
âœ… Abandoned Carts	Dashboard + sync logic	REQUIRED
âœ… Customer Portal	Order history, reorders, address book	REQUIRED

If any are not confirmed live + wired â†’ STOP deployment.

ğŸ”’ PHASE 2: SECURITY AUDIT â€” ATTACK SURFACE + ABUSE GUARDS
Risk Area	Must Be True
ğŸ§± Admin route protection	protectRoute(["admin"]) wraps all /admin/* endpoints
ğŸšª Guest spoofing	Cannot access /portal or reorders without Replit Auth
ğŸ§‘ Role escalation	No inline user.email.includes('admin') logic anywhere
ğŸ’³ Stripe exposure	No frontend access to secret keys, no hardcoded discounts
ğŸ§µ Webhook safety	Stripe webhook is validated via signature, not blindly trusted
ğŸ–¼ï¸ File uploads	Use Cloudinary only, mime-type checked, size-capped
ğŸ’£ Bundle enforcement	Childrenâ€™s products cannot be added or injected into bundles
ğŸ’° Discounts	Cannot be applied unless server validates usage, expiry, count
ğŸ§ª Session replay	All Stripe sessions are idempotent + tied to real metadata
ğŸ” DB rollback	Manual admin actions (e.g. refunds) log to admin_logs
ğŸ•µï¸â€â™€ï¸ Dev console traps	No console.log, debugger, TODO, or unused routes left
ğŸ” ENV protection	All secrets (Stripe, Cloudinary, DB) only loaded from .env

ğŸ§ª PHASE 3: FAILOVER + CHAOS SCENARIOS
Scenario	What Should Happen
âŒ Stripe webhook fails	Retry logic (or logs to monitor â€” prompt 18 for retries)
âŒ Reorder endpoint fails	User sees graceful error, funnel logs as failed
âŒ Admin uses invalid image	Upload fails safely, Cloudinary rejects
âŒ Cart has deleted product	Cart entry removed, UX shows fallback
âŒ Discount expired	UI message: â€œCode expiredâ€
âŒ Childrenâ€™s variant injected into bundle manually	Backend rejects with 400
âŒ User reuses used-up discount	â€œUsage limit reachedâ€ returned from backend
âŒ Admin refunds already-refunded order	API blocks double-refund
âŒ User force-navigates to /admin	Redirect to login or 403
âŒ Bundle is created, then variant is deleted	Bundle edit shows warning, not breaks frontend
âŒ Webhook sends unrecognised event	Handled in fallback default case without crashing

ğŸ› ï¸ PHASE 4: DEPLOYMENT-READY CHECKLIST
System Layer	Status
ğŸ§± Migrations pushed	âœ… npx drizzle-kit push up to date
ğŸ”‘ ENV injected	âœ… .env on Replit or Azure with:

STRIPE_SECRET_KEY

STRIPE_WEBHOOK_SECRET

CLOUDINARY_*

REPLIT_AUTH_*
|
| ğŸ” Admin email whitelist | âœ… Set in ALLOWED_ADMIN_EMAILS |
| âš™ï¸ Startup test route | âœ… GET /health returns 200 |
| ğŸ§ª Stripe test mode | âœ… Still in test mode until LIVE key swap |
| ğŸ§ª Replit logs clean | âœ… No unhandled errors, logs silent |
| ğŸ§ª Test suite (if any) | âœ… Manual test coverage from prompts 1â€“16 |

ğŸ“¦ SYSTEM INTEGRITY SCORE
âœ… PASS if:

No unguarded roles

No critical routes exposed

No mutable data untracked

No childrenâ€™s product in bundles

No pricing/discount abuse possible via frontend

Otherwise: block deployment.

ğŸ”š READY FOR LIVE?
If âœ… everything above is clean:

Flip Stripe from test to live

Inject real Cloudinary and domain-specific keys

Deploy with logging enabled