Prompt 16 (Revised): Bundle Logic â€” With Children's Product Exclusion
Objective: Build a robust bundle system that explicitly excludes any product variant tagged for children from being bundled. Admin validation and system-level filtering ensure child-specific SKUs cannot be added to bundles, even by accident or direct mutation.

âœ… PHASE 1: ASSUMPTIONS + STRUCTURE CHECK
Assumes:

âœ… Each product or variant includes a tags field, e.g. ["children", "immunity"] (Prompt 2/14)

âœ… Bundles are defined via product_variants (not products) â€” for accuracy and price traceability

ğŸ§± PHASE 2: DATABASE STRUCTURE (UNCHANGED)
Use:

ts
Copy
Edit
export const product_bundles = ...
export const bundle_items = ...
Same structure from original Prompt 16. No schema changes required â€” but variant selection logic must enforce exclusions at:

Admin UI layer

Backend bundle creation logic

Cart hydration (optional fallback enforcement)

ğŸš« PHASE 3: CHILDRENâ€™S PRODUCT FILTERING
1. Enforce on Admin Bundle Creation UI
In /admin/bundles.tsx, when fetching variants for dropdown:

ts
Copy
Edit
const res = await fetch("/admin/variants?excludeTags=children");
Backend:

ts
Copy
Edit
router.get("/variants", async (req, res) => {
  const exclude = req.query.excludeTags?.split(",") ?? [];
  const data = await db.select().from(product_variants)
    .leftJoin(products, eq(products.id, product_variants.product_id))
    .where(not(arrayContains(products.tags, exclude)));
  res.json(data);
});
âœ… Prevents children's products from being shown in the UI

2. Enforce on Backend /admin/bundles POST
Even if someone bypasses the UI, validate again:

ts
Copy
Edit
const variantIds = bundleItems.map(i => i.variant_id);
const childVariants = await db
  .select({ id: product_variants.id })
  .from(product_variants)
  .leftJoin(products, eq(products.id, product_variants.product_id))
  .where(and(
    inArray(product_variants.id, variantIds),
    arrayContains(products.tags, ["children"])
  ));

if (childVariants.length > 0) {
  return res.status(400).json({ error: "Childrenâ€™s products cannot be added to bundles" });
}
ğŸ§ª PHASE 4: FALLBACK CLIENT-SIDE VALIDATION (EXTRA LAYER)
In admin bundle builder:

ts
Copy
Edit
if (variant.tags.includes("children")) {
  return alert("This variant is for children and cannot be bundled.");
}
ğŸ›¡ï¸ PHASE 5: ENFORCED RULES SUMMARY
Layer	Exclusion Enforced?
Admin UI variant selector	âœ…
Backend bundle create API	âœ…
Cart add-bundle handler	âœ… (optional extra audit)
Stripe checkout	âœ… (only receives valid items)
Reorders / repurchase	âœ… (follows existing bundle definition)

ğŸš¨ LEGAL & BRAND NOTES
Bundling adult and childrenâ€™s products is often restricted in:

Supplement sales

Therapeutic claims jurisdictions (e.g. UK MHRA, US FDA)

Retail packaging standards (cross-use warnings)

Future bundle logic could include age-restricted tags, not just children

ğŸ“¦ OUTPUT FROM THIS REVISION
All bundle creation flows now exclude children's products

Child-tagged variants:

Not shown in admin UI

Rejected at backend if injected

Data-safe bundle creation guaranteed

No disruption to core variant/bundle/cart logic

